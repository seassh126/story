<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œí¬ì˜ ì½©ì¥íŒ¥ì¥ ì´ì•¼ê¸° íƒí—˜</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #FFF9C4;
            /* ì—°í•œ ë…¸ë‘ */
            --primary-color: #FFB74D;
            /* ì£¼í™© */
            --secondary-color: #4DB6AC;
            /* ì²­ë¡ */
            --accent-color: #FF8A65;
            /* ì‚´êµ¬ìƒ‰ */
            --text-color: #5D4037;
            /* ê³ ë™ìƒ‰ */
            --chat-bg: #FFFFFF;
            --user-msg-bg: #DCEDC8;
            /* ì—°ë‘ */
            --bot-msg-bg: #E1F5FE;
            /* í•˜ëŠ˜ */
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Jua', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0;
            color: var(--secondary-color);
            text-shadow: 2px 2px white;
        }

        .container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            height: calc(100% - 100px);
            /* í—¤ë” ì œì™¸ ë†’ì´ */
            gap: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border: 5px solid var(--primary-color);
        }

        /* ì™¼ìª½: ê·¸ë˜í”„ ì˜ì—­ */
        #graph-container {
            flex: 2;
            border: 3px dashed var(--secondary-color);
            border-radius: 15px;
            background-color: #FAFAFA;
            position: relative;
            overflow: hidden;
        }

        .graph-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 10;
        }

        /* ì˜¤ë¥¸ìª½: ì±—ë´‡ ì˜ì—­ */
        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 3px solid var(--accent-color);
            border-radius: 15px;
            background-color: var(--chat-bg);
            overflow: hidden;
        }

        .chat-header {
            background-color: var(--accent-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.5rem;
        }

        #chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 1.1rem;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-msg-bg);
            border-bottom-right-radius: 2px;
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-msg-bg);
            border-bottom-left-radius: 2px;
            border: 2px solid #B3E5FC;
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-msg-bg);
            border-bottom-left-radius: 2px;
            border: 2px solid #B3E5FC;
        }

        /* ì¶”ì²œ ì§ˆë¬¸ ì¹© ìŠ¤íƒ€ì¼ */
        .suggestions {
            padding: 10px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            background-color: #fafafa;
            border-top: 1px dashed #ddd;
            white-space: nowrap;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        .suggestions::-webkit-scrollbar {
            height: 5px;
        }

        .suggestions::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        .suggestion-chip {
            background-color: #E0F2F1;
            color: #00796B;
            border: 1px solid #4DB6AC;
            padding: 6px 12px;
            border-radius: 20px;
            font-family: 'Jua', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .suggestion-chip:hover {
            background-color: #B2DFDB;
            transform: translateY(-2px);
        }

        .input-area {
            padding: 10px;
            background-color: #f1f1f1;
            display: flex;
            gap: 10px;
            border-top: 2px solid #ddd;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid var(--secondary-color);
            border-radius: 25px;
            font-family: 'Jua', sans-serif;
            font-size: 1rem;
            outline: none;
        }

        input[type="text"]:focus {
            border-color: var(--primary-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-family: 'Jua', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s;
        }

        button:hover {
            background-color: #FFA726;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
                overflow-y: scroll;
            }

            #graph-container {
                height: 300px;
            }

            #chat-container {
                height: 400px;
            }

            body {
                overflow: auto;
                height: auto;
            }
        }
    </style>
</head>

<body>

    <header>
        <h1>âœ¨ ì„œí¬ì˜ ì½©ì¥íŒ¥ì¥ ì´ì•¼ê¸° íƒí—˜ âœ¨</h1>
    </header>

    <div class="container">
        <div id="graph-container">
            <div class="graph-label">ì´ì•¼ê¸° ì§€ë„</div>
            <div id="mynetwork" style="width: 100%; height: 100%;"></div>
        </div>

        <div id="chat-container">
            <div class="chat-header">
                ğŸ¤– ì²™ì²™ë°•ì‚¬ ë¡œë´‡
            </div>
            <div id="chat-messages">
                <div class="message bot-message">ì•ˆë…•! ë‚˜ëŠ” ì½©ì¥íŒ¥ì¥ ì´ì•¼ê¸°ë¥¼ ë‹¤ ì•Œê³  ìˆëŠ” ì²™ì²™ë°•ì‚¬ì•¼.<br>ì´ì•¼ê¸° ì§€ë„ì— ëŒ€í•´ ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë´ ì¤˜!</div>
            </div>

            <div class="suggestions">
                <button class="suggestion-chip" onclick="askSuggestion('ì½©ì¥ëŠ” ëˆ„êµ¬ì•¼?')">ì½©ì¥ëŠ” ëˆ„êµ¬ì•¼?</button>
                <button class="suggestion-chip" onclick="askSuggestion('ëˆ„ê°€ ì½©ì¥ë¥¼ ê´´ë¡­í˜€?')">ëˆ„ê°€ ì½©ì¥ë¥¼ ê´´ë¡­í˜€?</button>
                <button class="suggestion-chip" onclick="askSuggestion('ëˆ„ê°€ ì½©ì¥ë¥¼ ë„ì™€ì¤˜?')">ëˆ„ê°€ ë„ì™€ì¤˜?</button>
                <button class="suggestion-chip" onclick="askSuggestion('ì”ì¹˜ëŠ” ë­ì•¼?')">ì”ì¹˜ëŠ” ë­ì•¼?</button>
            </div>

            <div class="input-area">
                <input type="text" id="user-input" placeholder="ì˜ˆ: ì½©ì¥ëŠ” ëˆ„êµ¬ì•¼?">
                <button onclick="sendMessage()">ë¬¼ì–´ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // 1. RDF ë°ì´í„° (story.ttl ë‚´ìš© ê·¸ëŒ€ë¡œ)
        const ttlData = `
@prefix ex: <http://example.org/kongjwi-patjwi#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .

ex:Person rdf:type rdfs:Class .
ex:Animal rdf:type rdfs:Class .
ex:Object rdf:type rdfs:Class .
ex:Event rdf:type rdfs:Class .

ex:Kongjwi rdf:type ex:Person ;
    rdfs:label "ì½©ì¥" .

ex:Patjwi rdf:type ex:Person ;
    rdfs:label "íŒ¥ì¥" .

ex:Stepmother rdf:type ex:Person ;
    rdfs:label "ê³„ëª¨" ;
    ex:bullies ex:Kongjwi .

ex:Magistrate rdf:type ex:Person ;
    rdfs:label "ì›ë‹˜" .

ex:Ox rdf:type ex:Animal ;
    rdfs:label "ì†Œ" ;
    ex:helps ex:Kongjwi .

ex:Bird rdf:type ex:Animal ;
    rdfs:label "ìƒˆ" ;
    ex:helps ex:Kongjwi .

ex:SilkShoe rdf:type ex:Object ;
    rdfs:label "ë¹„ë‹¨ì‹ " .

ex:ForcedLabor rdf:type ex:Event ;
    rdfs:label "ì§‘ì•ˆì¼ ê°•ìš”" ;
    ex:involves ex:Kongjwi ;
    ex:causedBy ex:Stepmother .

ex:AnimalHelp rdf:type ex:Event ;
    rdfs:label "ë™ë¬¼ë“¤ì˜ ë„ì›€" ;
    ex:involves ex:Kongjwi ;
    ex:helper ex:Ox, ex:Bird ;
    ex:leadsTo ex:Festival .

ex:Festival rdf:type ex:Event ;
    rdfs:label "ì”ì¹˜" ;
    ex:involves ex:Kongjwi ;
    ex:uses ex:SilkShoe ;
    ex:leadsTo ex:ShoeSearch .

ex:ShoeSearch rdf:type ex:Event ;
    rdfs:label "ë¹„ë‹¨ì‹  ì£¼ì¸ ì°¾ê¸°" ;
    ex:conductedBy ex:Magistrate ;
    ex:findsOwner ex:Kongjwi ;
    ex:leadsTo ex:Marriage .

ex:Marriage rdf:type ex:Event ;
    rdfs:label "í˜¼ì¸" ;
    ex:involves ex:Kongjwi, ex:Magistrate .

ex:bullies rdf:type rdf:Property .
ex:helps rdf:type rdf:Property .
ex:involves rdf:type rdf:Property .
ex:helper rdf:type rdf:Property .
ex:causedBy rdf:type rdf:Property .
ex:uses rdf:type rdf:Property .
ex:conductedBy rdf:type rdf:Property .
ex:findsOwner rdf:type rdf:Property .
ex:leadsTo rdf:type rdf:Property .
        `;

        // 2. ê°„ë‹¨í•œ Turtle íŒŒì„œ
        const triples = [];
        const labels = {};
        const translations = {
            "bullies": "ê´´ë¡­í˜",
            "helps": "ë„ì™€ì¤Œ",
            "involves": "ê´€ë ¨ë¨",
            "helper": "ë„ìš°ë¯¸",
            "causedBy": "ì›ì¸ ì œê³µ",
            "uses": "ì‚¬ìš©í•¨",
            "conductedBy": "ì£¼ê´€í•¨",
            "findsOwner": "ì£¼ì¸ì„ ì°¾ìŒ",
            "leadsTo": "ì´ì–´ì§",
            "type": "ì¢…ë¥˜"
        };
        const nodeTypes = {}; // uri -> type

        function parseTurtle(data) {
            const lines = data.split('\n');
            let currentSubject = null;

            lines.forEach(line => {
                line = line.trim();
                if (!line || line.startsWith('#') || line.startsWith('@prefix')) return;

                // 1. Subject íŒŒì‹± (ex:Kongjwi ...)
                let parts = line.split(/\s+/);

                // ë§Œì•½ ë¬¸ì¥ì´ . ìœ¼ë¡œ ëë‚˜ë©´ ë§ˆì§€ë§‰ í† í° ì œê±°
                if (parts[parts.length - 1] === '.') parts.pop();

                // ; ë¡œ ëë‚˜ë©´ ë§ˆì§€ë§‰ í† í° ì œê±°, subject ìœ ì§€
                let endsWithSemi = false;
                if (parts[parts.length - 1] === ';') {
                    parts.pop();
                    endsWithSemi = true;
                }

                // , ë¡œ ëë‚˜ë©´ (ì´ê±´ ë‹¤ìŒ ì¤„ì— ì—°ê²°ë˜ëŠ” object ë¦¬ìŠ¤íŠ¸) -> ê°„ë‹¨í•œ íŒŒì„œë¥¼ ìœ„í•´ í•œ ì¤„ì— í•˜ë‚˜ì”© ê°€ì •í•˜ê±°ë‚˜, ì¢€ ë” ë³µì¡í•œ ë¡œì§ í•„ìš”.
                // ì´ íŒŒì¼ í¬ë§·ìƒ ;ëŠ” ì¤„ë°”ê¿ˆ ë˜ì§€ë§Œ ,ëŠ” í•œ ì¤„ì— ìˆì„ ìˆ˜ë„ ìˆìŒ.
                // ì˜ˆ: ex:helper ex:Ox, ex:Bird ; (ì´ ê²½ìš° parts=[ex:helper, ex:Ox,, ex:Bird])

                // ê°„ë‹¨ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì „ì²´ stringì„ í† í°í™”í•´ì„œ ìˆœì°¨ ì²˜ë¦¬
            });
        }

        // ì •êµí•œ íŒŒì‹± ëŒ€ì‹ , ì •ê·œì‹ ê¸°ë°˜ì˜ ì‹¬í”Œ íŒŒì„œ ì¬ì‘ì„±
        function parseSimple(ttl) {
            // ì£¼ì„ ì œê±°
            ttl = ttl.replace(/#.*/g, '');
            // prefix ì œê±°
            ttl = ttl.replace(/@prefix .*/g, '');

            // ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬ (.)
            const sentences = ttl.split(' .');

            sentences.forEach(sentence => {
                sentence = sentence.trim();
                if (!sentence) return;

                // ì„¸ë¯¸ì½œë¡ (;)ìœ¼ë¡œ ì£¼ì–´ì— ëŒ€í•œ ì—¬ëŸ¬ ì†ì„± ë¶„ë¦¬
                const tokenGroups = sentence.split(' ;');

                // ì²« ê·¸ë£¹ì—ì„œ ì£¼ì–´ ì°¾ê¸°
                let firstGroupParts = tokenGroups[0].trim().split(/\s+/);
                let subject = firstGroupParts[0]; // ex:Kongjwi
                let predicate = firstGroupParts[1];
                // Objectê°€ ì½¤ë§ˆë¡œ ì—°ê²°ëœ ê²½ìš° ì²˜ë¦¬
                let objectsPart = firstGroupParts.slice(2).join(' ');
                let objects = objectsPart.split(',').map(s => s.trim());

                // ì²« íŠ¸ë¦¬í”Œ ì €ì¥
                objects.forEach(obj => {
                    addTriple(subject, predicate, obj);
                });

                // ë‚˜ë¨¸ì§€ ê·¸ë£¹ (; ë’¤) ì²˜ë¦¬ - ì£¼ì–´ëŠ” ê·¸ëŒ€ë¡œ
                for (let i = 1; i < tokenGroups.length; i++) {
                    let groupParts = tokenGroups[i].trim().split(/\s+/);
                    let pred = groupParts[0];
                    let objsPart = groupParts.slice(1).join(' ');
                    let objs = objsPart.split(',').map(s => s.trim());

                    objs.forEach(obj => {
                        addTriple(subject, pred, obj);
                    });
                }
            });
        }

        function addTriple(s, p, o) {
            // ì •ë¦¬ (ex: ì œê±° ë“±ì€ ë‚˜ì¤‘ì—)
            triples.push({ s, p, o });

            // Label ì €ì¥
            if (p === 'rdfs:label') {
                labels[s] = o.replace(/"/g, '');
            }
            if (p === 'rdf:type') {
                nodeTypes[s] = o;
            }
        }

        parseSimple(ttlData);

        // 3. ê·¸ë˜í”„ ë°ì´í„° ë³€í™˜ (Vis.js í¬ë§·)
        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        const addedNodes = new Set();
        const addedTypeEdges = new Set(); // íƒ€ì… ê´€ê³„ëŠ” ê·¸ë˜í”„ê°€ ë„ˆë¬´ ë³µì¡í•´ì§€ë©´ ëº„ ìˆ˜ë„ ìˆìŒ

        // ë…¸ë“œ ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const typeColors = {
            'ex:Person': '#FFCCBC', // ì‚´êµ¬ìƒ‰
            'ex:Animal': '#C8E6C9', // ì—°ë‘ìƒ‰
            'ex:Object': '#FFF9C4', // ë…¸ë€ìƒ‰
            'ex:Event': '#E1F5FE',  // í•˜ëŠ˜ìƒ‰
            'rdfs:Class': '#E0E0E0' // íšŒìƒ‰
        };

        triples.forEach(t => {
            // ì‹œê°ì  ì—£ì§€ì¸ì§€ í™•ì¸ (rdf:type, rdfs:label ì œì™¸)
            const isVisualEdge = (t.p !== 'rdf:type' && t.p !== 'rdfs:label');

            if (isVisualEdge) {
                // ì´ ê´€ê³„ì— ì°¸ì—¬í•˜ëŠ” ë…¸ë“œë“¤(Subject, Object)ì„ ê·¸ë˜í”„ì— ì¶”ê°€
                [t.s, t.o].forEach(uri => {
                    if (!addedNodes.has(uri)) {
                        let group = nodeTypes[uri] || 'default';
                        let label = labels[uri] || uri.replace('ex:', ''); // ë¼ë²¨ ì—†ìœ¼ë©´ URI(ì˜ì–´) ë‚˜ì˜¤ì§€ë§Œ, ì´ ë°ì´í„°ì—” ë‹¤ ìˆìŒ

                        nodes.add({
                            id: uri,
                            label: label,
                            group: group,
                            color: typeColors[group] || '#eee',
                            shape: 'box',
                            font: { face: 'Jua', size: 16 }
                        });
                        addedNodes.add(uri);
                    }
                });

                // ì—£ì§€ ì¶”ê°€
                let edgeLabel = t.p.replace('ex:', '');
                if (translations[edgeLabel]) edgeLabel = translations[edgeLabel];

                edges.add({
                    from: t.s,
                    to: t.o,
                    label: edgeLabel,
                    arrows: 'to',
                    font: { align: 'middle', face: 'Jua' },
                    color: { color: '#B0BEC5' }
                });
            }
        });

        // nodeTypesë¥¼ ì´ìš©í•´ ë’¤ëŠ¦ê²Œ ì¶”ê°€ëœ ë…¸ë“œë“¤ì˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        nodes.forEach(node => {
            if (node.group === 'default' && nodeTypes[node.id]) {
                let realType = nodeTypes[node.id];
                nodes.update({
                    id: node.id,
                    group: realType,
                    color: typeColors[realType] || '#eee'
                });
            }
        });


        // 4. ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        const container = document.getElementById('mynetwork');
        const data = { nodes: nodes, edges: edges };
        const options = {
            physics: {
                stabilization: true,
                barnesHut: {
                    gravitationalConstant: -2000,
                    springConstant: 0.04,
                    springLength: 95
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200
            }
        };
        const network = new vis.Network(container, data, options);

        // 6. ê·¸ë˜í”„ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì±—ë´‡ê³¼ ì—°ê²°
        network.on("click", function (params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const label = labels[nodeId];
                if (!label) return;

                // ëŒ€ìƒì˜ íƒ€ì…ì— ë”°ë¼ ì§ˆë¬¸ ì–´ë¯¸ ì¡°ì • (ì‚¬ëŒ/ë™ë¬¼ -> ëˆ„êµ¬ì•¼?, ê·¸ì™¸ -> ë­ì•¼?)
                const type = nodeTypes[nodeId];
                let suffix = "ë­ì•¼?";
                if (type === 'ex:Person' || type === 'ex:Animal') {
                    suffix = "ëˆ„êµ¬ì•¼?";
                }

                const userText = `${label}(ì€)ëŠ” ${suffix}`;

                // 1. ìœ ì € ë©”ì‹œì§€ ì°½ì— í‘œì‹œ (ë§ˆì¹˜ ìœ ì €ê°€ ì§ˆë¬¸í•œ ê²ƒì²˜ëŸ¼)
                addMessage(userText, 'user');

                // 2. ë‹µë³€ ìƒì„± í˜¸ì¶œ
                setTimeout(() => {
                    // getAnswer í•¨ìˆ˜ê°€ ê·¸ë˜í”„ í¬ì»¤ì‹±ë„ ê°™ì´ ìˆ˜í–‰í•¨
                    const answer = getAnswer(userText);
                    addMessage(answer, 'bot');
                }, 400);
            }
        });


        // 5. ì±—ë´‡ ë¡œì§
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');

        // ì—”í„°í‚¤ ì²˜ë¦¬
        userInput.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

        function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';

            // ì±—ë´‡ ì‘ë‹µ ì§€ì—° íš¨ê³¼
            setTimeout(() => {
                const answer = getAnswer(text);
                addMessage(answer, 'bot');
            }, 500);
        }

        // ì¶”ì²œ ì§ˆë¬¸ í´ë¦­ ì‹œ ì‹¤í–‰
        function askSuggestion(text) {
            addMessage(text, 'user');
            setTimeout(() => {
                const answer = getAnswer(text);
                addMessage(answer, 'bot');
            }, 500);
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `message ${sender}-message`;
            div.innerHTML = text; // HTML í—ˆìš© (ì¤„ë°”ê¿ˆ ë“±)
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ì§ˆë¬¸ ë¶„ì„ ë° ë‹µë³€ ìƒì„±
        function getAnswer(question) {
            // 0. ì´ì•¼ê¸° ë§¥ë½ ì„¤ëª… ë°ì´í„° (í’ë¶€í•œ ë‹µë³€ìš©)
            const storyDescriptions = {
                "ex:Kongjwi": "<b>ì½©ì¥</b>ëŠ” ë§ˆìŒì”¨ ì°©í•˜ê³  ë¶€ì§€ëŸ°í•œ ì£¼ì¸ê³µì´ì•¼. ì¼ì° ì–´ë¨¸ë‹ˆë¥¼ ì—¬ì˜ê³  ê³„ëª¨ì™€ íŒ¥ì¥ì—ê²Œ êµ¬ë°•ì„ ë°›ì§€ë§Œ, êµ´í•˜ì§€ ì•Šê³  ì”©ì”©í•˜ê²Œ ì´ê²¨ë‚´ëŠ” ì•„ì´ë€ë‹¤. ê²°êµ­ ë³µì„ ë°›ì•„ ì›ë‹˜ê³¼ ê²°í˜¼í•´! ğŸŒ¸",
                "ex:Patjwi": "<b>íŒ¥ì¥</b>ëŠ” ì‹¬ìˆ ê¶‚ì€ ì½©ì¥ì˜ ì˜ë¶“ë™ìƒì´ì•¼. ì½©ì¥ë¥¼ ê´´ë¡­íˆê³  ì‹œìƒ˜í•˜ëŠ” ìš•ì‹¬ìŸì´ì§€. ì½©ì¥ê°€ í•˜ëŠ” ê±´ ë‹¤ ë”°ë¼í•˜ê³  ì‹¶ì–´ í•´. ğŸ˜ ",
                "ex:Stepmother": "<b>ê³„ëª¨</b>ëŠ” ì½©ì¥ì˜ ìƒˆì–´ë¨¸ë‹ˆì•¼. ì¹œë”¸ì¸ íŒ¥ì¥ë§Œ ì˜ˆë»í•˜ê³ , ì½©ì¥ì—ê²ŒëŠ” 'ìê°ˆë°­ ë§¤ê¸°'ë‚˜ 'ë°‘ ë¹ ì§„ ë…ì— ë¬¼ ë¶“ê¸°' ê°™ì€ í˜ë“  ì¼ë§Œ ì‹œí‚¤ëŠ” ë‚˜ìœ ì‚¬ëŒì´ì•¼. ğŸ‘¿",
                "ex:Magistrate": "<b>ì›ë‹˜</b>ì€ ì´ ê³ ì„ì„ ë‹¤ìŠ¤ë¦¬ëŠ” ë†’ì€ ë¶„ì´ì•¼. ìš°ì—°íˆ ì½©ì¥ê°€ ìƒì–´ë²„ë¦° ë¹„ë‹¨ì‹ ì„ ì¤ê²Œ ë˜ê³ , ê·¸ ì£¼ì¸ì„ ì°¾ì•„ë‚˜ì„œë‹¤ê°€ ì½©ì¥ë¥¼ ë§Œë‚˜ í˜¼ì¸í•˜ê²Œ ë¼. ğŸ¤µ",
                "ex:Ox": "<b>ì†Œ</b>ëŠ” ì½©ì¥ê°€ ë„“ì€ ìê°ˆë°­ì„ í˜¼ì ê°ˆì•„ì•¼ í•´ì„œ ìš¸ê³  ìˆì„ ë•Œ ë‚˜íƒ€ë‚œ ê³ ë§ˆìš´ ì¹œêµ¬ì•¼. 'ìŒë©”~' í•˜ê³  ë“ ë“ í•œ ëª¸ìœ¼ë¡œ ë°­ì„ ëŒ€ì‹  ê°ˆì•„ì£¼ì—ˆì–´. ğŸ®",
                "ex:Bird": "<b>ì°¸ìƒˆ</b>ë“¤ì€ ì½©ì¥ê°€ ì—„ì²­ ë§ì€ ë²¼ë¥¼ ì°§ì–´ì•¼ í•  ë•Œ ë–¼ë¡œ ë‚ ì•„ì™€ì„œ ë¶€ë¦¬ë¡œ ê»ì§ˆì„ ê¹Œì¤€ ê·€ì—¬ìš´ ë„ìš°ë¯¸ë“¤ì´ì•¼. ì§¹ì§¹! ğŸ¦",
                "ex:SilkShoe": "<b>ë¹„ë‹¨ì‹ </b>ì€ ì½©ì¥ê°€ ì„ ë…€ë‹˜ê»˜ ë°›ì€ ì˜ˆìœ ì‹ ë°œì¸ë°, ì”ì¹˜ì— ê°€ë ¤ë‹¤ ê¸‰í•´ì„œ ì‹œëƒ‡ê°€ì— í•œ ì§ì„ ë–¨ì–´ëœ¨ë¦¬ê³  ë§ì•˜ì–´. ë‚˜ì¤‘ì— ì›ë‹˜ê³¼ ì½©ì¥ë¥¼ ì´ì–´ì£¼ëŠ” ì‚¬ë‘ì˜ ì¦í‘œê°€ ë˜ì§€! ğŸ‘ ",
                "ex:ForcedLabor": "<b>ì§‘ì•ˆì¼ ê°•ìš”</b>ëŠ” ê³„ëª¨ê°€ ì½©ì¥ë¥¼ ì”ì¹˜ì— ëª» ê°€ê²Œ í•˜ë ¤ê³  ì‹œì‹œí‚¨ ë¶ˆê°€ëŠ¥í•œ ì¼ë“¤ì´ì•¼. í•˜ì§€ë§Œ ë™ë¬¼ ì¹œêµ¬ë“¤ì˜ ë„ì›€ìœ¼ë¡œ ëª¨ë‘ í•´ê²°í–ˆì§€! ğŸ’¦",
                "ex:AnimalHelp": "<b>ë™ë¬¼ë“¤ì˜ ë„ì›€</b>ì€ ê²€ì€ ì†Œ, ë‘êº¼ë¹„, ì°¸ìƒˆë“¤ì´ ë‚˜íƒ€ë‚˜ ì½©ì¥ì˜ í˜ë“  ì¼ì„ ë§ˆë²•ì²˜ëŸ¼ í•´ê²°í•´ì¤€ ì‚¬ê±´ì´ì•¼. ì°©í•œ ì½©ì¥ì—ê²Œ í•˜ëŠ˜ì´ ë‚´ë¦° ì„ ë¬¼ì´ì§€. âœ¨",
                "ex:Festival": "<b>ì”ì¹˜</b>ëŠ” ì›ë‹˜ì´ ë§ˆì„ ì‚¬ëŒë“¤ì„ ìœ„í•´ ì—° í° íŒŒí‹°ì•¼! ë§›ìˆëŠ” ìŒì‹ë„ ë§ê³  êµ¬ê²½ê±°ë¦¬ë„ ë§ì•„ì„œ ì½©ì¥ë„ ê¼­ ê°€ê³  ì‹¶ì–´ í–ˆì–´. ğŸ‰",
                "ex:ShoeSearch": "<b>ë¹„ë‹¨ì‹  ì£¼ì¸ ì°¾ê¸°</b>ëŠ” ì›ë‹˜ì´ ë¹„ë‹¨ì‹ ì˜ ì£¼ì¸ì„ ì°¾ê¸° ìœ„í•´ ì˜¨ ë§ˆì„ ì‚¬ëŒë“¤ì—ê²Œ ì‹ ë°œì„ ì‹ ê²¨ë³¸ ì¼ì´ì•¼. ê²°êµ­ ì½©ì¥ ë°œì— ì™ ë“¤ì–´ê°”ë‹¨ë‹¤! ğŸ”",
                "ex:Marriage": "<b>í˜¼ì¸</b>ì€ ì˜¨ê°– ê³ ë‚œì„ ì´ê²¨ë‚¸ ì½©ì¥ê°€ ì›ë‹˜ê³¼ ë§ºì–´ì§€ëŠ” í–‰ë³µí•œ ê²°ë§ì´ì•¼. ë‘˜ì€ ì˜¤ë˜ì˜¤ë˜ í–‰ë³µí•˜ê²Œ ì‚´ì•˜ëŒ€! ğŸ’–"
            };
            // 1. í‚¤ì›Œë“œ ì¶”ì¶œ (ì—”í‹°í‹° ì°¾ê¸°)
            let foundEntities = [];
            for (let uri in labels) {
                if (question.includes(labels[uri])) {
                    foundEntities.push(uri);
                }
            }

            // ê·¸ë˜í”„ ì‹œê°í™” ìƒí˜¸ì‘ìš©: ì–¸ê¸‰ëœ ëŒ€ìƒ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸
            if (foundEntities.length > 0) {
                network.selectNodes(foundEntities);
                // ì²« ë²ˆì§¸ ëŒ€ìƒì„ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™ ë° í™•ëŒ€
                network.focus(foundEntities[0], {
                    scale: 1.2,
                    animation: {
                        duration: 1000,
                        easingFunction: "easeInOutQuad"
                    }
                });
            } else {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: "easeInOutQuad"
                    }
                });
            }

            // 2. ë‹µë³€ ë¡œì§

            // í¸ì˜ë¥¼ ìœ„í•œ ë§¤í¼
            const q = question.replace(/\s+/g, ''); // ê³µë°± ì œê±° í›„ í™•ì¸

            // Q: ëˆ„êµ¬ì•¼? / ë­ì•¼? (ì •ì˜/íƒ€ì…/label)
            // "ëˆ„ê°€ì•¼", "ëˆ„êµ¬ë‹ˆ", "ëˆ„ê°€" (ì£¼ì–´ ì§ˆë¬¸ ë“±)
            if (question.includes("ëˆ„êµ¬") || question.includes("ë­ì•¼") || question.includes("ì–´ë–¤") || q.includes("ëˆ„ê°€ì•¼") || (question.includes("ëˆ„ê°€") && !question.includes("ê´´ë¡­") && !question.includes("ë„ì™€") && !question.includes("ë„ì›€"))) {
                if (foundEntities.length > 0) {
                    let subject = foundEntities[0];
                    // [NEW] ì´ì•¼ê¸° ì„¤ëª… ìš°ì„  ë°˜í™˜
                    if (storyDescriptions[subject]) {
                        return storyDescriptions[subject];
                    }

                    let type = nodeTypes[subject];
                    let label = labels[subject];

                    // ì£¼ì–´ì— ëŒ€í•œ ì„¤ëª… ì°¾ê¸°
                    let descriptions = [];

                    // íƒ€ì… ë²ˆì—­
                    let typeName = "ëŒ€ìƒ";
                    if (type === 'ex:Person') typeName = "ì‚¬ëŒ";
                    if (type === 'ex:Animal') typeName = "ë™ë¬¼";
                    if (type === 'ex:Event') typeName = "ì¤‘ìš”í•œ ì‚¬ê±´";
                    if (type === 'ex:Object') typeName = "ë¬¼ê±´";

                    // ì—°ê²°ëœ ê´€ê³„ ì°¾ê¸°
                    let relations = triples.filter(t => t.s === subject).map(t => {
                        let rel = translations[t.p.replace('ex:', '')] || t.p;
                        let target = labels[t.o] || t.o;
                        if (t.p === 'rdfs:label' || t.p === 'rdf:type') return null;
                        return `ğŸ‘‰ <b>${target}</b>ì™€(ê³¼) <b>${rel}</b> ê´€ê³„ì•¼.`;
                    }).filter(x => x);

                    // ì—­ë°©í–¥ ê´€ê³„ (ëˆ„ê°€ ì£¼ì–´ë¥¼ ~í–ˆë‚˜)
                    let reverseRelations = triples.filter(t => t.o === subject).map(t => {
                        let rel = translations[t.p.replace('ex:', '')] || t.p;
                        let footer = labels[t.s] || t.s;
                        if (t.p === 'rdfs:label' || t.p === 'rdf:type') return null;
                        return `ğŸ‘‰ <b>${footer}</b>ì—ê²Œ <b>${rel}</b> ë‹¹í–ˆê±°ë‚˜ ê´€ë ¨ì´ ìˆì–´.`;
                    }).filter(x => x);

                    let relationText = relations.length > 0 ? "<br>" + relations.join('<br>') : "";

                    return `<b>${label}</b>(ì€)ëŠ” ìš°ë¦¬ ì´ì•¼ê¸°ì˜ <b>${typeName}</b>ì´ì•¼!${relationText}`;
                }
            }

            // Q: ëˆ„ê°€ ~ë¥¼ ê´´ë¡­í˜€? (Subject ì°¾ê¸°)
            if ((question.includes("ëˆ„ê°€") || question.includes("ëˆ„êµ¬")) && (question.includes("ê´´ë¡­") || question.includes("ë‚˜ìœ"))) {
                let victim = foundEntities.find(uri => {
                    // ê´´ë¡­í˜ì„ ë‹¹í•˜ëŠ” ëŒ€ìƒì¸ì§€ í™•ì¸
                    return triples.some(t => t.p === 'ex:bullies' && t.o === uri);
                });
                // ë§Œì•½ í”¼í•´ìê°€ ëª…ì‹œë˜ì§€ ì•˜ì•˜ë‹¤ë©´ ì½©ì¥ë¡œ ê°€ì • (ë¬¸ë§¥ìƒ)
                if (!victim && question.includes("ëˆ„ê°€")) {
                    victim = "ex:Kongjwi";
                    // ì‹œê°í™” ì—…ë°ì´íŠ¸
                    network.selectNodes([victim]);
                }

                if (victim) {
                    let bully = triples.find(t => t.p === 'ex:bullies' && t.o === victim);
                    if (bully) {
                        // ê°€í•´ìì™€ í”¼í•´ì ëª¨ë‘ ì„ íƒ
                        network.selectNodes([bully.s, victim]);
                        network.focus(bully.s, { scale: 1.1, animation: true });
                        return `ì €ëŸ°! <b>${labels[victim]}</b>(ì„)ë¥¼ ê´´ë¡­íˆëŠ” ê±´ ë°”ë¡œ <b>${labels[bully.s]}</b>ì•¼! ì •ë§ ëª»ëì§€? ğŸ˜¤`;
                    }
                }
            }

            // Q: ëˆ„ê°€ ~ë¥¼ ë„ì™€ì¤˜?
            if ((question.includes("ëˆ„ê°€") || question.includes("ëˆ„êµ¬")) && (question.includes("ë„ì™€") || question.includes("ë„ì›€"))) {
                let helpee = foundEntities.find(uri => triples.some(t => t.p === 'ex:helps' && t.o === uri));
                if (!helpee && foundEntities.length > 0) helpee = foundEntities[0]; // ì–¸ê¸‰ëœ ì• ë¥¼ ë„ì™€ì£¼ëŠ”ì§€ í™•ì¸
                if (!helpee) helpee = 'ex:Kongjwi'; // ê¸°ë³¸ ì½©ì¥

                if (helpee) {
                    let helpers = triples.filter(t => t.p === 'ex:helps' && t.o === helpee);
                    if (helpers.length > 0) {
                        let names = helpers.map(h => labels[h.s]).join(', ');
                        // í—¬í¼ë“¤ ëª¨ë‘ ì„ íƒ
                        let allNodes = helpers.map(h => h.s);
                        allNodes.push(helpee);
                        network.selectNodes(allNodes);
                        network.fit({ nodes: allNodes, animation: true });

                        return `ì°©í•œ <b>${labels[helpee]}</b>(ì„)ë¥¼ ë„ì™€ì£¼ëŠ” ì¹œêµ¬ë“¤ì€ <b>${names}</b>(ì´)ì•¼! ì°¸ ê³ ë§™ì§€? ğŸ’–`;
                    }
                }
            }

            // Q: ~ëŠ” ì–´ë•Œ? (ì´ë²¤íŠ¸ ê´€ë ¨)
            if (question.includes("ì‚¬ê±´") || question.includes("ì¼ì–´")) {
                // ì´ë²¤íŠ¸ ì°¾ê¸°
                let events = triples.filter(t => nodeTypes[t.s] === 'ex:Event').map(t => labels[t.s]);
                return `ì´ ì´ì•¼ê¸°ì—ëŠ” <b>${events.join(', ')}</b> ê°™ì€ ì¼ë“¤ì´ ì¼ì–´ë‚˜!`;
            }

            // ì¼ë°˜ ê²€ìƒ‰: í‚¤ì›Œë“œê°€ í¬í•¨ëœ íŠ¸ë¦¬í”Œ ì •ë³´ ì•„ë¬´ê±°ë‚˜ ë§í•´ì£¼ê¸°
            if (foundEntities.length > 0) {
                let entity = foundEntities[0];
                let info = triples.filter(t => t.s === entity && t.p !== 'rdfs:label' && t.p !== 'rdf:type');
                if (info.length === 0) {
                    info = triples.filter(t => t.o === entity && t.p !== 'rdfs:label' && t.p !== 'rdf:type');
                }

                if (info.length > 0) {
                    let fact = info[0]; // í•˜ë‚˜ë§Œ ì˜ˆì‹œë¡œ, í˜¹ì€ ì—¬ëŸ¬ê°œ?
                    let s_label = labels[fact.s] || fact.s;
                    let o_label = labels[fact.o] || fact.o;
                    let p_label = translations[fact.p.replace('ex:', '')] || fact.p;
                    return `ì•Œë ¤ì¤„ê²Œ! <b>${s_label}</b>(ì€)ëŠ” <b>${o_label}</b>(ì™€)ê³¼ <b>${p_label}</b> ê´€ê³„ê°€ ìˆì–´. ê·¸ë˜í”„ë¥¼ í•œë²ˆ ë´ë³¼ë˜?`;
                }

                return `<b>${labels[entity]}</b>ì— ëŒ€í•´ ë” ê¶ê¸ˆí•œ ê²Œ ìˆë‹ˆ? 'ëˆ„ê°€ ë„ì™€ì¤˜?' ê°™ì´ ë¬¼ì–´ë´ ì¤˜!`;
            }

            return "ìŒ, ê·¸ê±´ ì˜ ëª¨ë¥´ê² ì–´. ğŸ˜…<br><b>'ì½©ì¥ëŠ” ëˆ„êµ¬ì•¼?'</b><br><b>'ëˆ„ê°€ ì½©ì¥ë¥¼ ê´´ë¡­í˜€?'</b><br>ì²˜ëŸ¼ ë¬¼ì–´ë´ ì¤„ë˜?";
        }

    </script>
</body>

</html>